name: ðŸ—‘ï¸ Cleanup Execution - Delete Resources

on:
  workflow_dispatch:
    inputs:
      confirm_execution:
        description: 'âš ï¸ DANGER: Type "EXECUTE DELETION" to confirm'
        required: true
        default: ''
        type: string
      skip_protection:
        description: 'Skip protection layer (NOT RECOMMENDED)'
        required: false
        default: false
        type: boolean
      verbosity_level:
        description: 'Verbosity level (0=quiet, 1=normal, 2=verbose)'
        required: false
        default: '1'
        type: choice
        options:
        - '0'
        - '1'
        - '2'

permissions:
  contents: read
  actions: write

jobs:
  validate-execution:
    runs-on: ubuntu-latest
    steps:
      - name: âš ï¸ Validate Execution Confirmation
        run: |
          echo "ðŸ” Validating execution confirmation..."
          
          if [[ "${{ inputs.confirm_execution }}" != "EXECUTE DELETION" ]]; then
            echo "âŒ EXECUTION CANCELLED: Invalid confirmation"
            echo "   You must type exactly 'EXECUTE DELETION' to confirm"
            echo "   Current input: '${{ inputs.confirm_execution }}'"
            exit 1
          fi
          
          echo "âœ… Execution confirmed"
          
          if [[ "${{ inputs.skip_protection }}" == "true" ]]; then
            echo "âš ï¸ WARNING: Protection layer will be bypassed"
          else
            echo "ðŸ›¡ï¸ Protection layer active"
          fi

  execute-cleanup:
    runs-on: ubuntu-latest
    needs: validate-execution
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: latest

      - name: Configure JFrog CLI for Admin
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
        run: |
          jf c add bookverse-admin --url="${JFROG_URL}" --access-token="${JFROG_ADMIN_TOKEN}" --interactive=false --overwrite
          jf c use bookverse-admin

      - name: ðŸ—‘ï¸ Execute BookVerse Project Cleanup
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          VERBOSITY: ${{ inputs.verbosity_level }}
          SKIP_PROTECTION: ${{ inputs.skip_protection }}
        run: |
          echo "ðŸ—‘ï¸ EXECUTION MODE: Deleting BookVerse resources"
          echo "==============================================="
          echo ""
          echo "âš ï¸ WARNING: This will PERMANENTLY DELETE resources!"
          echo ""
          
          if [[ "$SKIP_PROTECTION" == "true" ]]; then
            echo "ðŸš¨ PROTECTION BYPASSED - Automatic deletion enabled"
          else
            echo "ðŸ›¡ï¸ Protection layer active - Will fail if interactive approval needed"
          fi
          
          echo ""
          echo "ðŸš€ Starting cleanup execution..."
          
          ./.github/scripts/setup/cleanup_project_based.sh

      - name: ðŸ“‹ Execution Summary
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "## âœ… Cleanup Execution Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ¯ **All BookVerse resources have been deleted successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Cleanup Execution Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” **Check the logs above for details**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ’¡ Common Causes:" >> $GITHUB_STEP_SUMMARY
            echo "- Protection layer blocked execution (needs manual approval)" >> $GITHUB_STEP_SUMMARY
            echo "- Network/authentication issues" >> $GITHUB_STEP_SUMMARY
            echo "- Resources locked by other processes" >> $GITHUB_STEP_SUMMARY
          fi
