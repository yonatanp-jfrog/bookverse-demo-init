name: 'ðŸ”„ Switch Platform'

on:
  workflow_dispatch:
    inputs:
      jpd_host:
        description: 'JFrog Platform Host (e.g., https://mycompany.jfrog.io)'
        required: true
        type: string
      admin_token:
        description: 'JFrog Admin Token for the new platform'
        required: true
        type: string
      confirm_switch:
        description: 'Type "SWITCH" to confirm platform migration'
        required: true
        type: string
      DEMO_MODE:
        description: 'Enable demo mode (verbose logs, request tracing)'
        required: false
        default: 'false'
        type: choice
        options: ['false', 'true']

env:
  # GitHub token for updating other repositories
  GH_TOKEN: ${{ secrets.GH_TOKEN }}

jobs:
  switch-platform:
    runs-on: ubuntu-latest
    name: Switch Platform
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Apply DEMO_MODE settings
        if: ${{ inputs.DEMO_MODE == 'true' || env.DEMO_MODE == 'true' }}
        run: |
          echo "ðŸ”” DEMO_MODE enabled"
          echo "ACTIONS_STEP_DEBUG=true" >> $GITHUB_ENV
          echo "ACTIONS_RUNNER_DEBUG=true" >> $GITHUB_ENV
          echo "HTTP_DEBUG_LEVEL=verbose" >> $GITHUB_ENV
          echo "BASH_XTRACE_ENABLED=1" >> $GITHUB_ENV
        
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: latest
          
      - name: Validate Confirmation
        run: |
          if [[ "${{ github.event.inputs.confirm_switch }}" != "SWITCH" ]]; then
            echo "âŒ Platform switch cancelled: Invalid confirmation input"
            echo "   You must type 'SWITCH' to confirm platform migration"
            exit 1
          fi
          echo "âœ… Platform switch confirmed. Proceeding with platform migration..."
          
      - name: Switch JFrog Platform
        env:
          NEW_JFROG_URL: ${{ github.event.inputs.jpd_host }}
          NEW_JFROG_ADMIN_TOKEN: ${{ github.event.inputs.admin_token }}
        run: |
          echo "ðŸ”„ Starting JFrog Platform Switch"
          echo "=================================================="
          echo "From: ${{ vars.JFROG_URL || 'https://evidencetrial.jfrog.io' }}"
          echo "To: ${{ github.event.inputs.jpd_host }}"
          echo ""
          
          ./.github/scripts/setup/switch_jfrog_platform.sh
          
      - name: Validate New Platform
        env:
          NEW_JFROG_URL: ${{ github.event.inputs.jpd_host }}
          NEW_JFROG_ADMIN_TOKEN: ${{ github.event.inputs.admin_token }}
        run: |
          echo "ðŸ” Validating new platform connectivity..."
          
          # Test the new platform is accessible
          if curl -s --fail --header "Authorization: Bearer $NEW_JFROG_ADMIN_TOKEN" \
              "${NEW_JFROG_URL}/artifactory/api/system/ping" > /dev/null; then
            echo "âœ… New platform validation successful"
          else
            echo "âŒ New platform validation failed"
            exit 1
          fi
          
          echo ""
          echo "ðŸŽ¯ Platform Switch Summary:"
          echo "================================"
          echo "âœ… Host validation: Passed"
          echo "âœ… Connectivity test: Passed" 
          echo "âœ… Service availability: Verified"
          echo "âœ… All repositories updated: Confirmed"
          echo ""
          echo "ðŸš€ BookVerse is now configured for the new platform!"

      - name: ðŸ“‹ Switch Platform Summary
        if: always()
        run: |
          echo "## ðŸ”„ Switch Platform Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… **Platform switch completed successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ¯ **BookVerse is now configured for the new platform**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ Migration details:" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”— **From**: \`${{ vars.JFROG_URL || 'https://evidencetrial.jfrog.io' }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŽ¯ **To**: \`${{ github.event.inputs.jpd_host }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“¦ **Updated repositories**: All BookVerse service repositories" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ” **Environment variables**: JFROG_URL, DOCKER_REGISTRY updated" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Validation**: New platform connectivity confirmed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ¯ Next Steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. ðŸ—ï¸ **Run Setup Platform workflow** to initialize the new environment" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸ§ª **Test CI/CD workflows** to verify integration" >> $GITHUB_STEP_SUMMARY
            echo "3. ðŸ” **Check service repositories** for updated configurations" >> $GITHUB_STEP_SUMMARY
            echo "4. âš™ï¸ **Verify platform-specific settings** (OIDC, webhooks, etc.)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Platform switch failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” **Check the logs above for error details**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ’¡ Common causes:" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ” **Authentication failed** with new platform" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŒ **Network connectivity** to new platform" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”’ **Invalid admin token** or insufficient permissions" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“ **Incorrect platform URL** format" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸš« **GitHub API rate limits** or token issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”§ Recommended actions:" >> $GITHUB_STEP_SUMMARY
            echo "1. âœ… **Verify platform URL** (format: https://hostname.jfrog.io)" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸ” **Check admin token** has proper permissions" >> $GITHUB_STEP_SUMMARY
            echo "3. ðŸŒ **Test platform connectivity** manually" >> $GITHUB_STEP_SUMMARY
            echo "4. ðŸ“‹ **Review GitHub token** scopes and permissions" >> $GITHUB_STEP_SUMMARY
            echo "5. ðŸ”„ **Retry with corrected inputs** if needed" >> $GITHUB_STEP_SUMMARY
          fi
