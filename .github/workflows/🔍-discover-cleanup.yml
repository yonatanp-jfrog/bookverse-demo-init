name: 'ðŸ” Discover Cleanup'

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  discover-resources:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: latest

      - name: Configure JFrog CLI for Admin
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
        run: |
          jf c add bookverse-admin --url="${JFROG_URL}" --access-token="${JFROG_ADMIN_TOKEN}" --interactive=false --overwrite
          jf c use bookverse-admin

      - name: ðŸ” Discovery Phase - Find Resources to Delete
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          VERBOSITY: ${{ inputs.verbosity_level }}
        run: |
          echo "ðŸ” DISCOVERY MODE: Finding resources to delete"
          echo "=============================================="
          echo ""
          echo "This workflow ONLY discovers and reports - NO DELETION occurs"
          echo ""
          
          # Create discovery-only script in the correct directory
          cd .github/scripts/setup
          cp cleanup_project_based.sh discovery_only.sh
          
          # Modify to stop after discovery (before get_user_approval)
          cat > discovery_patch.sh << 'EOF'
          echo ""
          echo "ðŸ›¡ï¸ DISCOVERY COMPLETE - NO DELETION PERFORMED"
          echo "=============================================="
          echo ""
          echo "ðŸ“‹ To execute the deletion:"
          echo "  1. Review the preview above carefully"
          echo "  2. Run ðŸ—‘ï¸ Execute Cleanup workflow"
          echo "  3. Set SKIP_PROTECTION=true for automated deletion"
          echo ""
          echo "ðŸ’¾ Preview saved to: $preview_file"
          exit 0
          EOF
          
          # Replace the user approval CALL (not the function definition) with discovery completion
          sed -i '/if ! get_user_approval/,/^fi$/c\
          # Discovery mode - show results and exit\
          echo ""\
          echo "ðŸ›¡ï¸ DISCOVERY COMPLETE - NO DELETION PERFORMED"\
          echo "=============================================="\
          echo ""\
          echo "ðŸ“‹ To execute the deletion:"\
          echo "  1. Review the preview above carefully"\
          echo "  2. Run ðŸ—‘ï¸ Execute Cleanup workflow"\
          echo "  3. Set SKIP_PROTECTION=true for automated deletion"\
          echo ""\
          echo "ðŸ’¾ Preview saved to: $preview_file"\
          exit 0' ./discovery_only.sh
          
          # Run discovery from the correct directory
          bash ./discovery_only.sh
          cd - # Return to root directory
          
          # Find the preview file and add it to job summary
          preview_file=$(find /tmp -name "deletion_preview.txt" 2>/dev/null | head -1)
          if [[ -f "$preview_file" ]]; then
            echo "ðŸ“‹ Preview file found: $preview_file"
          else
            echo "âš ï¸ Preview file not found, will extract from temp directory"
            preview_file="/tmp/bookverse_cleanup_*/deletion_preview.txt"
          fi

      - name: ðŸ“‹ Discovery Report Summary
        run: |
          echo "## ðŸ” Cleanup Discovery Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Discovery completed successfully**" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”§ **Discovery Mode**: Detailed output (shows all discovered resources)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find and include the detailed preview file content
          preview_file=$(find /tmp -name "deletion_preview.txt" 2>/dev/null | head -1)
          if [[ -f "$preview_file" ]]; then
            echo "### ðŸ“‹ Resources Discovered for Deletion:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Parse and format the preview file for better readability
            echo "#### ðŸ“Š **Quick Summary**" >> $GITHUB_STEP_SUMMARY
            repo_count=$(grep -c "âŒ Repository:" "$preview_file" 2>/dev/null || echo "0")
            user_count=$(grep -c "âŒ User:" "$preview_file" 2>/dev/null || echo "0") 
            app_count=$(grep -c "âŒ Application:" "$preview_file" 2>/dev/null || echo "0")
            stage_count=$(grep -c "âŒ Stage:" "$preview_file" 2>/dev/null || echo "0")

            build_count=$(grep -c "âŒ Build:" "$preview_file" 2>/dev/null || echo "0")
            
            echo "| Resource Type | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|---------------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“¦ Repositories | $repo_count |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ‘¥ Users | $user_count |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸš€ Applications | $app_count |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ·ï¸ Stages | $stage_count |" >> $GITHUB_STEP_SUMMARY

            echo "| ðŸ”§ Builds | $build_count |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract detailed lists for each category
            if grep -q "REPOSITORIES TO DELETE" "$preview_file"; then
              echo "#### ðŸ“¦ **Repositories**" >> $GITHUB_STEP_SUMMARY
              grep "âŒ Repository:" "$preview_file" | head -20 | sed 's/.*âŒ Repository: /- `/' | sed 's/$/`/' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            if grep -q "USERS TO DELETE" "$preview_file"; then
              echo "#### ðŸ‘¥ **Users**" >> $GITHUB_STEP_SUMMARY
              grep "âŒ User:" "$preview_file" | head -15 | sed 's/.*âŒ User: /- `/' | sed 's/$/`/' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            if grep -q "APPLICATIONS TO DELETE" "$preview_file"; then
              echo "#### ðŸš€ **Applications**" >> $GITHUB_STEP_SUMMARY
              grep "âŒ Application:" "$preview_file" | head -10 | sed 's/.*âŒ Application: /- `/' | sed 's/$/`/' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            if grep -q "STAGES TO DELETE" "$preview_file"; then
              echo "#### ðŸ·ï¸ **Stages**" >> $GITHUB_STEP_SUMMARY
              grep "âŒ Stage:" "$preview_file" | head -5 | sed 's/.*âŒ Stage: /- `/' | sed 's/$/`/' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            if grep -q "BUILDS TO DELETE" "$preview_file"; then
              echo "#### ðŸ”§ **Builds**" >> $GITHUB_STEP_SUMMARY
              grep "âŒ Build:" "$preview_file" | head -10 | sed 's/.*âŒ Build: /- `/' | sed 's/$/`/' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>ðŸ“„ <strong>Click to see complete raw discovery report</strong></summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat "$preview_file" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ No preview file generated" >> $GITHUB_STEP_SUMMARY
            echo "Discovery may have failed or no bookverse resources were found." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Possible reasons:**" >> $GITHUB_STEP_SUMMARY
            echo "- No BookVerse project resources exist" >> $GITHUB_STEP_SUMMARY
            echo "- Discovery script failed" >> $GITHUB_STEP_SUMMARY
            echo "- Resources exist in different project scope" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. ðŸ‘€ **Review the discovery report above** carefully" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ—‘ï¸ **Run Execute Cleanup workflow** to execute deletion" >> $GITHUB_STEP_SUMMARY
          echo "3. âš ï¸ **Type 'DELETE' and optionally set skip_protection=true** for execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Important:" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ” Discover Cleanup** workflow **DOES NOT DELETE** anything" >> $GITHUB_STEP_SUMMARY
          echo "- Resources are only **discovered and reported**" >> $GITHUB_STEP_SUMMARY
          echo "- Use **ðŸ—‘ï¸ Execute Cleanup** workflow for actual deletion" >> $GITHUB_STEP_SUMMARY
