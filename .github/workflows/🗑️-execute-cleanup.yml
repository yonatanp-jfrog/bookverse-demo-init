name: 'ðŸ—‘ï¸ Cleanup (Preview & Execute)'

on:
  workflow_dispatch:
    inputs:
      confirm_cleanup:
        description: 'Type "DELETE" to confirm cleanup (leave empty for preview mode)'
        required: false
        type: string
        default: ''
      mode:
        description: 'Operation mode'
        required: true
        type: choice
        options:
          - 'preview'
          - 'execute'
        default: 'preview'

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4



      - name: Setup JFrog CLI
        uses: EyalDelarea/setup-jfrog-cli@swampUpAppTrust
        with:
          version: latest

      - name: "Preflight: require JFROG_URL"
        run: |
          if [[ -z "${{ vars.JFROG_URL }}" ]]; then
            echo "âŒ Missing vars.JFROG_URL. Set repository variable JFROG_URL before running." >&2
            exit 1
          fi

      - name: Configure JFrog CLI for Admin
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
        run: |
          jfrog config add bookverse-admin --url="$JFROG_URL" --access-token="$JFROG_ADMIN_TOKEN" --interactive=false --overwrite
          jfrog config use bookverse-admin

      - name: Validate input and confirmation
        run: |
          if [[ "${{ inputs.mode }}" == "execute" && "${{ inputs.confirm_cleanup }}" != "DELETE" ]]; then
            echo "âŒ Confirmation failed. You must type 'DELETE' exactly to proceed with actual cleanup."
            echo "Current input: '${{ inputs.confirm_cleanup }}'"
            echo "To preview resources without deletion, use 'preview' mode instead."
            exit 1
          fi
          
          if [[ "${{ inputs.mode }}" == "preview" ]]; then
            echo "ðŸ” PREVIEW MODE: Will discover and show resources that would be deleted"
            echo "â„¹ï¸  No actual deletions will be performed"
          else
            echo "âœ… EXECUTE MODE: Confirmation verified, proceeding with actual cleanup"
          fi

      - name: Generate fresh discovery or validate existing report
        id: validate
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          PROJECT_KEY: 'bookverse'
        run: |
          if [[ "${{ inputs.mode }}" == "preview" ]]; then
            echo "ðŸ” PREVIEW MODE: Generating fresh discovery..."
            echo "report_valid=true" >> "$GITHUB_OUTPUT"
            
            # Run discovery to generate fresh report
            cd .github/scripts/setup
            export SKIP_PROTECTION=true
            bash -c 'source ./cleanup_project_based.sh && run_discovery_preview' || {
              echo "âš ï¸ Discovery failed but continuing..."
              exit 0
            }
            cd -
            
            if [[ -f ".github/cleanup-report.json" ]]; then
              echo "âœ… Fresh discovery report generated successfully"
            else
              echo "âš ï¸ Discovery completed but no report generated"
              echo "report_valid=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "ðŸ” EXECUTE MODE: Validating existing cleanup report..."
            set +e
            bash ./.github/scripts/setup/validate_cleanup_report.sh
            status=$?
            if [[ $status -eq 0 ]]; then
              echo "report_valid=true" >> "$GITHUB_OUTPUT"
            else
              echo "report_valid=false" >> "$GITHUB_OUTPUT"
              if [[ -f ".github/cleanup-report.json" ]]; then
                ts=$(jq -r '.metadata.timestamp // "unknown"' .github/cleanup-report.json)
                pretty_ts=$(date -u -d "$ts" +"%a, %b %d %Y %H:%M:%S %Z" 2>/dev/null || echo "$ts")
                echo "Report is not usable - missing, invalid, or expired." >> $GITHUB_STEP_SUMMARY
                echo "- Last report timestamp: $pretty_ts" >> $GITHUB_STEP_SUMMARY
              else
                echo "No cleanup report found. Run this workflow in 'preview' mode first to generate a fresh report." >> $GITHUB_STEP_SUMMARY
              fi
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- Run this workflow in 'preview' mode to generate a fresh report." >> $GITHUB_STEP_SUMMARY
              echo "- Then re-run in 'execute' mode to perform actual cleanup." >> $GITHUB_STEP_SUMMARY
              exit 0
            fi
          fi

      - name: ðŸ“± Delete application versions (step 1 of dependency chain)
        if: ${{ steps.validate.outputs.report_valid == 'true' }}
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          PROJECT_KEY: 'bookverse'
        run: |
          set -uo pipefail
          # Delete application versions first (highest level dependencies)
          DRY_RUN=${{ inputs.mode == 'preview' && 'true' || 'false' }}
          bash ./.github/scripts/setup/cleanup_from_report_phase.sh app_versions $DRY_RUN 2>&1 | tee -a /tmp/cleanup_execution.log || echo "âš ï¸ Some application versions may have issues - continuing with cleanup"

      - name: ðŸ”§ Delete builds (step 2 of dependency chain)
        if: ${{ steps.validate.outputs.report_valid == 'true' }}
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          PROJECT_KEY: 'bookverse'
        run: |
          set -uo pipefail
          # Delete builds after application versions are removed
          DRY_RUN=${{ inputs.mode == 'preview' && 'true' || 'false' }}
          bash ./.github/scripts/setup/cleanup_from_report_phase.sh builds $DRY_RUN 2>&1 | tee -a /tmp/cleanup_execution.log || echo "âš ï¸ Some builds may not exist - continuing with cleanup"

      - name: ðŸ“¦ Delete repositories/artifacts (step 3 of dependency chain)
        if: ${{ steps.validate.outputs.report_valid == 'true' }}
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          PROJECT_KEY: 'bookverse'
        run: |
          set -euo pipefail
          # Delete repositories/artifacts after builds are removed
          DRY_RUN=${{ inputs.mode == 'preview' && 'true' || 'false' }}
          bash ./.github/scripts/setup/cleanup_from_report_phase.sh repositories $DRY_RUN 2>&1 | tee -a /tmp/cleanup_execution.log

      - name: ðŸš€ Delete applications (step 4 of dependency chain)
        if: ${{ steps.validate.outputs.report_valid == 'true' }}
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          PROJECT_KEY: 'bookverse'
        run: |
          set -uo pipefail
          # Delete applications after all their dependencies are removed
          DRY_RUN=${{ inputs.mode == 'preview' && 'true' || 'false' }}
          bash ./.github/scripts/setup/cleanup_from_report_phase.sh applications $DRY_RUN 2>&1 | tee -a /tmp/cleanup_execution.log || echo "âš ï¸ Some applications may have dependency issues - continuing with cleanup"

      - name: ðŸ‘¥ Remove project users (from report)
        if: ${{ steps.validate.outputs.report_valid == 'true' }}
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          PROJECT_KEY: 'bookverse'
        run: |
          set -euo pipefail
          DRY_RUN=${{ inputs.mode == 'preview' && 'true' || 'false' }}
          bash ./.github/scripts/setup/cleanup_from_report_phase.sh users $DRY_RUN 2>&1 | tee -a /tmp/cleanup_execution.log

      - name: ðŸ”„ Clear lifecycle config (safety)
        if: ${{ steps.validate.outputs.report_valid == 'true' }}
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          PROJECT_KEY: 'bookverse'
        run: |
          set -euo pipefail
          DRY_RUN=${{ inputs.mode == 'preview' && 'true' || 'false' }}
          if [[ "$DRY_RUN" == "true" ]]; then
            echo "ðŸ” [DRY RUN] Would clear lifecycle configuration for project: bookverse"
            echo "ðŸ” [DRY RUN] Would remove all promote stages from lifecycle"
          else
            bash -c 'source ./.github/scripts/setup/cleanup_project_based.sh; delete_project_lifecycle; wait_for_lifecycle_cleared 20 2 || true'
          fi 2>&1 | tee -a /tmp/cleanup_execution.log

      - name: ðŸ·ï¸ Delete stages (from report)
        if: ${{ steps.validate.outputs.report_valid == 'true' }}
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          PROJECT_KEY: 'bookverse'
        run: |
          set -euo pipefail
          DRY_RUN=${{ inputs.mode == 'preview' && 'true' || 'false' }}
          bash ./.github/scripts/setup/cleanup_from_report_phase.sh stages $DRY_RUN 2>&1 | tee -a /tmp/cleanup_execution.log

      - name: ðŸ” Delete OIDC integrations (from report)
        if: ${{ steps.validate.outputs.report_valid == 'true' }}
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          PROJECT_KEY: 'bookverse'
        run: |
          set -euo pipefail
          DRY_RUN=${{ inputs.mode == 'preview' && 'true' || 'false' }}
          bash ./.github/scripts/setup/cleanup_from_report_phase.sh oidc $DRY_RUN 2>&1 | tee -a /tmp/cleanup_execution.log

      - name: ðŸ‘¥ Delete global @bookverse.com users (from report)
        if: ${{ steps.validate.outputs.report_valid == 'true' }}
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          PROJECT_KEY: 'bookverse'
        run: |
          set -euo pipefail
          DRY_RUN=${{ inputs.mode == 'preview' && 'true' || 'false' }}
          bash ./.github/scripts/setup/cleanup_from_report_phase.sh domain_users $DRY_RUN 2>&1 | tee -a /tmp/cleanup_execution.log

      - name: ðŸŽ¯ Delete project (final)
        id: run_cleanup
        if: ${{ steps.validate.outputs.report_valid == 'true' }}
        env:
          JFROG_URL: ${{ vars.JFROG_URL }}
          JFROG_ADMIN_TOKEN: ${{ secrets.JFROG_ADMIN_TOKEN }}
          PROJECT_KEY: 'bookverse'
        run: |
          set -euo pipefail
          DRY_RUN=${{ inputs.mode == 'preview' && 'true' || 'false' }}
          bash ./.github/scripts/setup/cleanup_from_report_phase.sh project $DRY_RUN 2>&1 | tee -a /tmp/cleanup_execution.log

      - name: ðŸ“‹ Cleanup Summary (Preview & Execute)
        if: always()
        env:
          CLEANUP_REPORT_VALID: ${{ steps.validate.outputs.report_valid }}
          MODE: ${{ inputs.mode }}
        run: |
          report_file=".github/cleanup-report.json"
          exec_log="/tmp/cleanup_execution.log"

          project_key="unknown"
          report_status="unknown"
          total_items="unknown"
          ts_pretty="unknown"
          if [[ -f "$report_file" ]]; then
            project_key=$(jq -r '.metadata.project_key // "unknown"' "$report_file")
            report_status=$(jq -r '.status // "unknown"' "$report_file")
            total_items=$(jq -r '.metadata.total_items // "0"' "$report_file")
            ts=$(jq -r '.metadata.timestamp // "unknown"' "$report_file")
            ts_pretty=$(date -u -d "$ts" +"%a, %b %d %Y %H:%M:%S %Z" 2>/dev/null || echo "$ts")
          fi

          overall="UNKNOWN"
          project_deleted="unknown"
          failed_any="false"
          if [[ -f "$exec_log" ]]; then
            if grep -Eq "âŒ (Failed to delete|Stage '.*' still exists|Some deletions failed|PROJECT DELETION INCOMPLETE)" "$exec_log"; then
              failed_any="true"
            fi
            if grep -Eq "âœ… Project '.*' deleted successfully" "$exec_log"; then
              project_deleted="yes"
            elif grep -Eq "âŒ Failed to delete project '.*'" "$exec_log"; then
              project_deleted="no"
            fi
          fi

          if [[ "$MODE" == "preview" ]]; then
            echo "**ðŸ” Overall Result: Discovery and Preview Completed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This preview shows what **would** be deleted in execute mode." >> $GITHUB_STEP_SUMMARY
            echo "No actual deletions were performed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the preview below" >> $GITHUB_STEP_SUMMARY
            echo "2. If you want to proceed, run this workflow again with:" >> $GITHUB_STEP_SUMMARY
            echo "   - Mode: \`execute\`" >> $GITHUB_STEP_SUMMARY
            echo "   - Confirmation: \`DELETE\`" >> $GITHUB_STEP_SUMMARY
          else
            if [[ "$failed_any" == "true" ]] || [[ "$report_status" == "stale_report" ]] || [[ "$project_deleted" == "no" ]]; then
              overall="FAILED"
            elif [[ "$report_status" == "cleanup_completed" ]] || [[ "$project_deleted" == "yes" ]]; then
              overall="SUCCESS"
            elif [[ -f "$exec_log" ]]; then
              overall="PARTIAL"
            fi

            if [[ "$overall" == "SUCCESS" ]]; then
              echo "**âœ… Overall Result: Cleanup Succeeded**" >> $GITHUB_STEP_SUMMARY
            elif [[ "$overall" == "FAILED" ]]; then
              echo "**âŒ Overall Result: Cleanup FAILED**" >> $GITHUB_STEP_SUMMARY
            else
              echo "**âš ï¸ Overall Result: Partial/Unknown**" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          if [[ -n "$project_key" ]]; then echo "- **Project**: $project_key" >> $GITHUB_STEP_SUMMARY; fi
          if [[ -n "$ts_pretty" ]]; then echo "- **Last report timestamp**: $ts_pretty UTC" >> $GITHUB_STEP_SUMMARY; fi
          if [[ -n "$report_status" ]]; then echo "- **Report status**: $report_status" >> $GITHUB_STEP_SUMMARY; fi
          if [[ -n "$total_items" ]]; then echo "- **Items in report**: $total_items" >> $GITHUB_STEP_SUMMARY; fi
          if [[ "$project_deleted" == "yes" ]]; then echo "- **Project deletion**: âœ… deleted" >> $GITHUB_STEP_SUMMARY; fi
          if [[ "$project_deleted" == "no" ]]; then echo "- **Project deletion**: âŒ failed" >> $GITHUB_STEP_SUMMARY; fi

          if [[ "$overall" != "SUCCESS" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> The workflow run can be green even if cleanup failed. This section reflects the cleanup outcome from logs and the report." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Detailed Results" >> $GITHUB_STEP_SUMMARY
          if [[ -f "$exec_log" ]]; then
            repos=$(grep -E "âœ… Repository '.*' deleted successfully" "$exec_log" | sed -E "s/.*Repository '([^']+)'.*/- \1/") || true
            echo "**Repositories Deleted:**" >> $GITHUB_STEP_SUMMARY
            if [[ -n "$repos" ]]; then echo "$repos" >> $GITHUB_STEP_SUMMARY; else echo "- None" >> $GITHUB_STEP_SUMMARY; fi

            users=$(grep -E "âœ… User '.*' (removed from project|deleted) successfully" "$exec_log" | sed -E "s/.*User '([^']+)'.*/- \1/") || true
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Users Removed:**" >> $GITHUB_STEP_SUMMARY
            if [[ -n "$users" ]]; then echo "$users" >> $GITHUB_STEP_SUMMARY; else echo "- None" >> $GITHUB_STEP_SUMMARY; fi

            apps=$(grep -E "âœ… Application '.*' deleted successfully" "$exec_log" | sed -E "s/.*Application '([^']+)'.*/- \1/") || true
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Applications Deleted:**" >> $GITHUB_STEP_SUMMARY
            if [[ -n "$apps" ]]; then echo "$apps" >> $GITHUB_STEP_SUMMARY; else echo "- None" >> $GITHUB_STEP_SUMMARY; fi

            stages=$(grep -E "âœ… (Project stage|Stage) '.*' deleted successfully" "$exec_log" | sed -E "s/.*'(.*)'.*/- \1/") || true
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Stages Deleted:**" >> $GITHUB_STEP_SUMMARY
            if [[ -n "$stages" ]]; then echo "$stages" >> $GITHUB_STEP_SUMMARY; else echo "- None" >> $GITHUB_STEP_SUMMARY; fi

            builds=$(grep -E "âœ… Build '.*' deleted successfully" "$exec_log" | sed -E "s/.*Build '([^']+)'.*/- \1/") || true
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Builds Deleted:**" >> $GITHUB_STEP_SUMMARY
            if [[ -n "$builds" ]]; then echo "$builds" >> $GITHUB_STEP_SUMMARY; else echo "- None" >> $GITHUB_STEP_SUMMARY; fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Failed Operations:**" >> $GITHUB_STEP_SUMMARY
            repos_failed=$(grep -E "âŒ .*repository '.*'" "$exec_log" | sed -E "s/.*'([^']+)'.*/- \1/" | sort -u) || true
            users_failed=$(grep -E "âŒ Failed to (remove|delete) user '.*'" "$exec_log" | sed -E "s/.*'([^']+)'.*/- \1/" | sort -u) || true
            apps_failed=$(grep -E "âŒ Failed to delete application '.*'" "$exec_log" | sed -E "s/.*'([^']+)'.*/- \1/" | sort -u) || true
            stages_failed=$(grep -E "âŒ (Failed to delete stage|Stage '.*' still exists)" "$exec_log" | sed -E "s/.*'([^']+)'.*/- \1/" | sort -u) || true
            builds_failed=$(grep -E "âŒ Failed to delete build '.*'" "$exec_log" | sed -E "s/.*'([^']+)'.*/- \1/" | sort -u) || true

            echo "Repositories that failed:" >> $GITHUB_STEP_SUMMARY
            if [[ -n "$repos_failed" ]]; then echo "$repos_failed" >> $GITHUB_STEP_SUMMARY; else echo "- None" >> $GITHUB_STEP_SUMMARY; fi
            echo "Users that failed:" >> $GITHUB_STEP_SUMMARY
            if [[ -n "$users_failed" ]]; then echo "$users_failed" >> $GITHUB_STEP_SUMMARY; else echo "- None" >> $GITHUB_STEP_SUMMARY; fi
            echo "Applications that failed:" >> $GITHUB_STEP_SUMMARY
            if [[ -n "$apps_failed" ]]; then echo "$apps_failed" >> $GITHUB_STEP_SUMMARY; else echo "- None" >> $GITHUB_STEP_SUMMARY; fi
            echo "Stages that failed:" >> $GITHUB_STEP_SUMMARY
            if [[ -n "$stages_failed" ]]; then echo "$stages_failed" >> $GITHUB_STEP_SUMMARY; else echo "- None" >> $GITHUB_STEP_SUMMARY; fi
            echo "Builds that failed:" >> $GITHUB_STEP_SUMMARY
            if [[ -n "$builds_failed" ]]; then echo "$builds_failed" >> $GITHUB_STEP_SUMMARY; else echo "- None" >> $GITHUB_STEP_SUMMARY; fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Notes:**" >> $GITHUB_STEP_SUMMARY
            if [[ -f "$report_file" ]]; then
              echo "- Note: The report is not auto-refreshed after deletion. If it still shows items, run ðŸ” Discover Cleanup again to regenerate it." >> $GITHUB_STEP_SUMMARY
              echo "- Current report status: $(jq -r '.status' "$report_file")" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>ðŸ“„ Raw Execution Log (tail)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -200 "$exec_log" >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Execution log not found" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "$MODE" == "execute" ]] && [[ "${CLEANUP_REPORT_VALID}" == "true" ]] && [[ "$overall" != "SUCCESS" ]]; then
            echo "Cleanup result: $overall - project_deleted=$project_deleted. Failing job." >&2
            exit 1
          elif [[ "$MODE" == "preview" ]]; then
            echo "Preview mode completed successfully"
          fi

      - name: ðŸ”’ Commit report changes (preview or post-execution)
        if: ${{ always() && steps.validate.outputs.report_valid == 'true' }}
        run: |
          set -euo pipefail
          report_file=".github/cleanup-report.json"
          if [[ -f "$report_file" ]]; then
            if [[ "${{ inputs.mode }}" == "preview" ]]; then
              echo "Committing fresh discovery report from preview mode..."
              commit_msg="chore: Update cleanup discovery report (preview mode)"
            else
              echo "Committing cleanup report changes after execution..."
              commit_msg="chore: Update cleanup report after execution"
            fi
            
            git config --global user.name "BookVerse Cleanup Bot"
            git config --global user.email "cleanup@bookverse.demo"
            git add "$report_file"
            if git diff --cached --quiet; then
              echo "ðŸ“‹ No changes to commit for cleanup report"
            else
              git commit -m "$commit_msg"
              git push origin ${{ github.ref_name }}
              echo "ðŸ“‹ Cleanup report changes pushed"
            fi
          else
            echo "No cleanup report found to invalidate"
          fi
